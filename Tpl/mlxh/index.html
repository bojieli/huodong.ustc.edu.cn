<html>
  <head>
    <title>美丽邂逅2012</title>
    <meta charset="utf-8">
    <style type="text/css">
      #landing{
        width: 1024px;
        height: 576px;
        background: url("/static/mlxh/img/ml_big.jpg") no-repeat;
        margin: 0 auto;
        margin-top: 10px;
        position: relative;
      }
      #mlxh_content{
        position: absolute;
        top:520px;
        left:100px;
        /*margin-left:-400px; */
      }
      #mlxh_content a{
        text-decoration: none;
        text-align: center;
        font-style: italic;
        font-size: 18px;
        font-family: "微软雅黑";
        padding: 3px;
        height: 25px;
        width:60px;
        display: block;
        border:1px solid #e62589;
        float: left;
        margin-left: 30px;
      }
      #mlxh_content span{
        float: left;
        color:#e62589;
        font-size: 24px;
        font-style: italic;
        margin-left: 30px;
        padding: 3px;
      }
      #mlxh_content a:link{
        background: url("/static/mlxh/img/mlxh_bt1.png");
        background-color:#ffffff;
        color:#e62589; 
      }
      #mlxh_content a:hover{
        background: url("/static/mlxh/img/mlxh_bt2.png");
        color:#ffffff;
        background-color:#e62589; 
      }
    </style>
  </head>
  <body>
    <div id="landing">
    <div id="mlxh_content">
    <if condition="empty($theday)">
      <span id="daojishi">秒杀和抽奖将于11月1日开始，请耐心等待 :)</span>
    <elseif condition="$_G['uid'] == 0" />
      <a id="mlxh_reg" href="/User/register">注册</a>
      <a id="mlxh_login" href="/User/login">登录</a>
      <span id="daojishi">需要注册或登录才能秒杀或抽奖</span>
    <elseif condition="empty($miaoshaguole)" />
      <a id="mlxh_miaosha" class="disabled" style="cursor:pointer">秒杀</a>
      <a id="mlxh_choujiang" class="" style="cursor:pointer">抽奖</a>
      <span id="daojishi">载入中……</span>
    <else />
      <span id="daojishi">恭喜你，秒杀成功！</span>
    </if>
    </div>
      
    </div>
    <script src="/static/mlxh/js/jquery.js"></script>
    <script src="/static/mlxh/js/bootstrap.min.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
<?php
    date_default_timezone_set('Asia/Chongqing');
    $t = localtime(time(), true);
?>
	var now = new Date(
            <?=$t['tm_year']+1900?>,
            <?=$t['tm_mon']+1?>,
            <?=$t['tm_mday']?>,
            <?=$t['tm_hour']?>,
            <?=$t['tm_min']?>,
            <?=$t['tm_sec']?>
            );
    var theTime =new Date(now.getFullYear(),now.getMonth(),now.getDay(),12,30,00);
    var isTime = false;

    function leftTime(){
      var time_now = now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
      var time_up = theTime.getHours()*3600+theTime.getMinutes()*60+theTime.getSeconds();
      if (time_now - time_up > 3600) // 12:30 ~ 13:30
        return "今天的秒杀已经结束，明天12:30再来吧 :)";
      if (time_now - time_up >= 0) {
        isTime = true;
        return "秒杀已经开始啦，赶快抢票吧";
      }
      var leftH = (time_up-time_now)/3600;
      leftH=Math.floor(leftH);
      var leftM = (time_up-time_now-3600*leftH)/60;
      leftM = Math.floor(leftM);
      var leftS = time_up-time_now-3600*leftH-60*leftM;
      return "距下次秒杀还有 "+leftH+"小时"+leftM+"分"+leftS+"秒";
    }  
    function refresh(){      
      // document.getElementById("clock").innerHTML = now.getFullYear()+"年"+now.getMonth()+"月"+now.getDate()+"日 "+ CurentTime();
      if(!isTime){
        document.getElementById("daojishi").innerHTML = leftTime();
      }else{
        $("#mlxh_miaosha").removeClass("disabled");
        $("#mlxh_miaosha").html('<b>抢票</b>');        
      }
      now.setSeconds(now.getSeconds()+1);
    } 
    if ($('#mlxh_miaosha').html()) {
        intervalId = setInterval(refresh,1000);
        $('#mlxh_miaosha').attr("intervalId", intervalId);
    }
    
    //$("#mlxh_miaosha").css("display","none");
    //$("#mlxh_choujiang").css("display","none");
    })

    function stopCounting() {
        clearInterval($('#mlxh_miaosha').attr('intervalId'));
    }

    $('#mlxh_miaosha').click(function(){
        if ($(this).hasClass('disabled')) {
            $('#daojishi').html("秒杀还没有开始，再等一会儿吧 :)");
            return;
        }
        if ($(this).hasClass('done')) {
            $('#daojishi').html("你已经秒杀成功啦！");
            return;
        }
        $.ajax({
            url: '/mlxh/miaosha',
            dataType: 'json',
            success: function(obj) {
                stopCounting();
                if(obj.status) {
                    $('#daojishi').html(obj.msg);
                    $('#mlxh_miaosha').addClass('done');
                    $('#mlxh_choujiang').addClass('done');
                } else {
                    $('#daojishi').html(obj.msg);
                }
            },
            error: function(e) {
                stopCounting();
                $('#daojishi').html("服务器错误，请重试");
            }
        });
    });

    $('#mlxh_choujiang').click(function(){
        if ($(this).hasClass('disabled')) {
            $('#daojishi').html("你已经提交过抽奖<br>请耐心等待11月9日的开奖！");
            return;
        }
        if ($(this).hasClass('done')) {
            $('#daojishi').html("你已经秒杀成功啦！");
            return;
        }
        $.ajax({
            url: '/mlxh/choujiang',
            dataType: 'json',
            success: function(obj) {
                stopCounting();
                if(obj.status) {
                    $('#daojishi').html(obj.msg);
                } else {
                    $('#daojishi').html(obj.msg);
                }
                $('#mlxh_choujiang').addClass('disabled');
            },
            error: function(e) {
                $('#daojishi').html("服务器错误，请重试");
                stopCounting();
            }
       });
    });
    </script>     
  </body>
</html>
