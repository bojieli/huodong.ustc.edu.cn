<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>学生团体 - 群发短信</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="/static/css1.css" rel="stylesheet" type="text/css" />
<script src="/static/jquery.js" type="text/javascript"></script>
<script src="/static/jsjq1.js" type="text/javascript"></script>
<script type="text/javascript">
var rname;
$(document).ready(function(){
/*弹出短信选择框*/
$("#msn_sel_mem").click(function(){	 
	$("#msn_selmem_box").show(300);
	$("#backbg1").css("display","block");	
	});

$("#giveup_sel").click(function(){	 
	$("#msn_selmem_box").hide(300);
	$("#backbg1").css("display","none");
	});
$("#backbg1").click(function(){	 
	$("#msn_selmem_box").hide(300);
	$("#backbg1").css("display","none");	
	});
$("#msn_selmem_tjsx").live('click',function(){
	$("#msn_selmem_box").hide(300);
	$("#backbg1").css("display","none");
	$(".mss-input-1text").html('');
    var len = $("#members_select option").length;
	if(len >= 30){
		alert("抱歉,您已经选择"+len+"人，超过了30人的限制，请重新选择。");
		return;
	}
	var i =0;
	var mobiles = '';
	var rname = '';
	$("#members_select option").each(function() {
		var values = $(this).val().split(";");
		if(values[2]=='')
		{
			$(".mss-input-1text").append("<span class='NameWithBg' style='color:red' title='无手机号'>"+values[1]+"</span>   ");
		}
		else
		{
			$(".mss-input-1text").append("<span class='NameWithBg'  title='"+values[2]+"'>"+values[1]+"</span>   ");
			mobiles += values[0]+";"
			rname   += values[1]+' ';
			i++;
		}
     });
	 ///alert(i);
	 $("#tid_num").val(i);
	 $("#tid").val(mobiles);
	 $("#rname").val(rname);
	});

//发送控制
$("#confirm-alert").click(function(){	
	$("#backbg,#alertbox,#alert-cont-box").slideUp(300);								   
});
});//document.ready
function sendSms()
{
	$("#backbg").css("display","block");
	var fixCenLeft = parseInt(www/2)-240+"px";
	var fixCenTop = parseInt(hhh/2)-130+"px";
	$("#alertbox,#alert-cont-box").css("top",fixCenTop);
	$("#alertbox,#alert-cont-box").css("left",fixCenLeft);	
	$("#alertbox").slideDown(300);	
	
	var form = $("#SmsSend");
	$.post($(form).attr('action'), $(form).serialize(), function (data) {
	if(data.info[1]){
	if($("#sms_num").text()<$("#tid_num").val())
		{   
		 //  alert('剩余短信条数不足');
			   $("#sendMssage-result").html("<span style='color:green; font-size:20px; '>发送失败：<br/></span><span style='margin-left:40px; line-height:24px;'>剩余短信条数不足！</span>" );
			   return false;
		} 
	}
		if (data.status == 1) {
			if(data.info[1])
				$("#sms_num").text(data.info[1]);			
			$(".mss-input-1text").html('');
			$("#sendMssage-result").html("<span style='color:green; font-size:20px; '>发送成功：<br/></span><span style='margin-left:40px; line-height:24px;'>"+ data.info[0] +"</span>" );
			var d = new Date();
			var vYear = d.getFullYear();
			var vMon = d.getMonth() + 1;
			var vDay = d.getDate();
			var h = d.getHours(); 
			var m = d.getMinutes();
			var vtime = vYear+'年'+vMon+'月'+vDay+'日  '+h+':'+m;
			$("#history-finish").append('<div title="接收者:'+$("#rname").val()+'" class="history-area" style="padding:10px;background: #FFF5FA;margin:20px 10px;font-size:16px; font-family:Microsoft YaHei; color:#8E8E90; text-align:left; "><div class="history-list-title" style="color:#ddd;font-size:60%;border-bottom: 1px solid #ddd">成功发出'+$("#tid_num").val()+'条 <img src="static/check_green.gif" /><span class="sender" style="float:right">发信人：我</span></div><div class="history-list-cont">'+$('#edit').val()+'</div><p style="font-size:12px; color:#999;font-family:Microsoft YaHei; text-align:right;margin:5px 0px 0 0;">'+vtime+'</p></div>');
			
			$("#tid").val('');
			$("#edit").val('');
		} 
		else if(data.status==0 ) {
	        $("#sendMssage-result").html("<span style='color:green; font-size:20px; '>发送信息失败：<br/></span><span style='margin-left:40px; line-height:24px;'>"+ data.info[0] +"</span>" );
		}
		$("#alert-cont-box").slideDown(100);
	}, 'json');
    return false;
};
//-->
</script>
<!--筛选列表的css样式表-->
<style type="text/css">
.mss-tittle{
	font-family:Microsoft Yahei, "Times New Roman", Times, serif;
	font-size:25px;
	color:#99F;
	margin-bottom:5px;
	font-weight:bold;
	background:#DDDDDD;
	line-height:40px;
	vertical-align:middle;
	border-bottom:2px solid #9bc;
	}
.mss-button{
	margin:auto 10px;
	width:80px;
	height:28px;
	line-height:27px;
	vertical-align:middle;
	text-align:center;
	padding:0 6px;
	font-size:16px;	
	font-family:Microsoft Yahei, "Times New Roman", Times, serif;
	background:#FC0;
	}
.mss-input-1text{
	  font-family:Microsoft Yahei, "Times New Roman", Times, serif;		  	  
	  font-size:14px;	  
	  outline:none;		  
	  background:#F9F8F6;
	  line-height:20px;
	  vertical-align:middle;
	  padding:8px;
	  margin:0;
	  margin-bottom:6px;
	  color:#999;
	  max-height:400px;
	  min-height:13px;

	}
.mss-input-text{
	font-family:Microsoft Yahei, "Times New Roman", Times, serif;
	font-size:16px;
	width:590px;
	line-height:22px;
	height:140px;
	padding:10px;		
	-webkit-border-radius: 5px;
	-moz-border-radius: 5px;
	border-radius:5px;
	outline:none;
	}
#giveup_sel{
	color:#F33;
	margin-left:30px;
	}
#giveup_sel:hover{
	cursor:pointer;
	}
#msn_selmem_box{
	position:absolute;
	top:-0px;
	left:160px;
	margin:0 auto;
	z-index:11000;
	width:700px;
	height:560px;
	text-align:center;
	padding:10px 40px;
	-moz-border-radius: 4px;
	-webkit-border-radius: 4px;
	border-radius:4px;
	background:#fafafa;
	display:none;
	}
.NameWithBg{
	background:#E9E9E9;
	border:solid #CCC;
	border-width:0 1px 1px 0;
	-moz-border-radius: 9px;
	-webkit-border-radius: 9px;
	border-radius:9px;
	margin:2px 1px;
	padding: 0px 10px;
	white-space: nowrap;
	display: inline-block;
	}
.NameWithBg:hover{
	cursor:default;
	background:#CFC;
}
</style>
</head>


<body>
<script type="text/javascript">
<!--
getwindowWH();//调用函数获取数值
window.onresize=function(){
getwindowWH();//调用函数获取数值
}
//-->
</script>
<include file="Public:headnav" />
<div id="mainding" style="position:relative; overflow: scroll;">
  <p class="mss-tittle">
<empty name="admin">
<notempty name="club"> {$club['school']['name']} - <a href="/Club/manage?gid={$club.gid}">{$club['name']}</a></notempty><notempty name="team"><a href="/Club/manage?gid={$team.gid}">{$team['club']}</a> - <a href="/Team?tid={$team.tid}">{$team['name']}</a></notempty> - 群发短信通知</p>
<else />
{$sname_admin} - 群发短信通知</p>
</empty>
<include file="Public:selectMember" />
<form action="/Sms/sent" id="SmsSend" method="post">
<div id="leftbox" style="float:left">
<table border="0" cellpadding="0" cellspacing="0">
<tr height="40px">
	<td width="90" align="right" valign="top" style="padding-top:3px;">发短信给：</td>
	<td width="120" align="left" valign="top">
	<div id="msn_sel_mem" class="dxhb-button mss-button" style="margin:0;">选择会员</div>
	
	</td>
	<td width="475"><p style="color:#ddd">建议每次群发人数不要超过30人，以免页面响应时间过长。</p></td>
</tr>
<tr>
	<td width="90" align="right" valign="top" style="padding-top:3px; color:#CCC">已选会员：</td>
	<td colspan="2"  align="left" valign="top">
		<div class='mss-input-1text' style="width:595px;">
		</div>
		<input type="hidden" name="tid" id="tid" value=""/>
		<input type="hidden" id="tid_num" value=""/>
		<input type="hidden" id="rname" value=""/>
		<empty name="admin">
		<input type="hidden" name="gid" value="<notempty name="club">{$club.gid}</notempty><notempty name="team">{$team.gid}</notempty>"/>
		<else />
		<input type="hidden" name='sid' value="$Think.get.sid"/>
		</empty>
	</td>
</tr>
<tr>
	<td width="90" align="right" valign="top" style="padding-top:10px;">短信内容：</td>
	<td colspan="2"  align="left" valign="top">
		<div class="inputarea" style="position:relative;">
			<textarea id="edit" name="s" title="短信不宜过长，最好控制在一条内，以节省短信条数" class="mss-input-text" onfocus="this.className='dxhb-focus mss-input-text'" onblur="this.className='dxhb-blur mss-input-text'" style="float:left" ></textarea>
			<!--span style=" color:#F00;"><br/>&nbsp;&nbsp;&nbsp;写满两行文字的长度<br/>&nbsp;&nbsp;&nbsp;约为一条短信 ！</span-->
			
			<span style="position:absolute;left:473px;top:135px;color:#8E8E90">
			还可输入<span id="counter" style="color:#F00"></span>字节
			</span>
			<span id="smscfbox" style="position:absolute;left:275px;top:135px;color:#8E8E90;display:none">
			拆分为<span id="smscf" style="color:#F00"></span>条
			</span>
			<empty name="admin">
			<span style="position:absolute;left:20px;top:135px;color:#8E8E90">
			还剩<span id="sms_num" style="color:#F00">{$sms_num}</span>条短信
			</span>
			</empty>
		</div>
	</td>
</tr>
<tr>
   <td> </td>
   <td colspan="2" align="left" valign="middle" style="height:70px;">
		<div  onclick="sendSms();return false;" class="dxhb-button mss-button" style="margin-left:518px;">发 送</div>
   </td>
</tr>
</table>
</div>
<empty name="admin">
<div id="rightbox" style="float:left;">
<p style="text-align:center;padding:9px">群短信发送记录
<span style="color:#F00; font-weight:normal; font-family:Georgia, 'Times New Roman', Times, serif">( {$allSmsNum} )</span>
</p>
<div class="smsArae" style="background:#fff;height: 500px;width:360px;overflow: auto;">
<div id="history-finish"></div>
<volist name="history" id="vo">
	<div title="接收者:{$vo['nameString']}" class="history-area" style="padding:10px;background: #FFF5FA;margin:20px 10px;font-size:16px; font-family:Microsoft YaHei; color:#8E8E90; text-align:left; ">
	<div class="history-list-title" style="color:#ddd;font-size:60%;border-bottom: 1px solid #ddd">
	成功发出{$vo['pid_num']}条
	<span class="sender" style="float:right">
	发信人：{$vo['realname']}
	</span>
	</div>
	<div class="history-list-cont">
	{$vo['msg']}
	</div>
	<p style="font-size:12px; color:#999;font-family:Microsoft YaHei; text-align:right;margin:5px 0px 0 0;">
    {$vo.humanDate}
    </p>
	</div>
</volist>
</div>
</div>
</empty>
<script type="text/javascript">
var edit = document.getElementById("edit");
		if(window.localStorage){
			edit.onblur = function(){
				localStorage.setItem("msg", this.value);
				textarea=this.value;
			};
			if(localStorage.getItem("msg")){
				edit.value = localStorage.getItem("msg");	
			}
		}
function mbStringLength(s) {
        var totalLength = 0;
        var i;
        var charCode;
        for (i = 0; i < s.length; i++) {
          charCode = s.charCodeAt(i);
          if (charCode < 0x007f) {
            totalLength = totalLength + 1;
          } else if ((0x0080 <= charCode) && (charCode <= 0x07ff)) {
            totalLength += 2;
          } else if ((0x0800 <= charCode) && (charCode <= 0xffff)) {
            totalLength += 3;
          }
        }
        //alert(totalLength);
        return totalLength;
      } 
function tmp(){    
		var area=$("#edit");
		var max = 600;
		var input = mbStringLength(area.val());
		$('#counter').text(max-input);
		var i=1;
		while(input > 200){
			i++;
			input -= 200;
		}
		$('#smscf').text(i);
		if(i>1){
		$('#smscfbox').show();
		}else{
		$('#smscfbox').hide();
		}
		var limit=$('#counter').text();
		if(max>0){ 
            if(limit<0){ 
				 area.val(area.val().substr(0,area.val().length-1));    //截断textarea的文本重新赋值             
            } 
        } 
}
setInterval("tmp()",0);
/*function countChar(textareaName,spanName)
{  
  document.getElementById(spanName).innerHTML = 200 - mbStringLength(document.getElementById(textareaName).value);
	onkeydown='countChar("edit","counter");' onkeyup='countChar("edit","counter");'
}  660*/
</script>
<script type="text/javascript">
//
</script>
	
</form>

</div><!--main ding-->

<!--弹出框样式代码-->
<div id="backbg"></div><!--不可点击自身消失-->
<div id="backbg1"></div><!--可点击自身消失-->
<div id="alertbox" style="text-align:center;"><img src="/static/images/loading1.gif" style="width:124px; margin:66px auto" /></div>
<div id="alert-cont-box">
	<div class="alert-title">群短信发送结果</div>
    <div id="sendMssage-result" class="alert-cont"></div>
    <div id="confirm-alert" class="dxhb-button alert-button" >确 认</div>
</div>

</body>
</html>