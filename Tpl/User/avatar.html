<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="/static/jquery.js" type="text/javascript"></script>
<script src="/static/jquery.form.js" type="text/javascript"></script>
<script src="/static/jquery.Jcrop.js"></script>
<link href="/static/css1.css" type="text/css" rel="stylesheet" />
<link rel="stylesheet" href="/static/jquery.Jcrop.css" type="text/css" />

<script language="Javascript">
$(function(){
	$('#uploadForm').ajaxForm({
                complete: function(data) {
                        var info = eval('(' + data.responseText + ')');
                        if(info.status=='1')
                        {
                                var img_src = "/upload/avatar/"+info.info;
								//alert(img_src);
                                $("#avatar2").attr("src",img_src);
								$("#preview").attr("src",img_src);
								//alert($("#avatar2").attr("src"));
								var jcrop_api, boundx, boundy;
								$('#avatar2').Jcrop({
									aspectRatio: 1,
									onChange: updateCoords,
									onSelect: updateCoords
								},
								function(){
									// Use the API to get the real image size
									var bounds = this.getBounds();
									boundx = bounds[0];
									boundy = bounds[1];
									// Store the API in the jcrop_api variable
									jcrop_api = this;
								  }
								);
                        }
                        else
                        {
                                alert(info.info);
                        }
                }
     });
});
			


			function updateCoords(c)
			{
				$('#x').val(c.x);
				$('#y').val(c.y);
				$('#w').val(c.w);
				$('#h').val(c.h);
				if (parseInt(c.w) > 0)
				{
				  var rx = 100 / c.w;
				  var ry = 100 / c.h;

				  $('#preview').css({
					width: Math.round(rx * boundx) + 'px',
					height: Math.round(ry * boundy) + 'px',
					marginLeft: '-' + Math.round(rx * c.x) + 'px',
					marginTop: '-' + Math.round(ry * c.y) + 'px'
				  });
				}
			};

			function checkCoords()
			{
				if (parseInt($('#w').val())) return true;
				alert('Please select a crop region then press submit.');
				return false;
			};

		</script>

	</head>

	<body>

	<div id="outer">
	<div class="jcExample">
	<div class="article">

		<h1>Jcrop - Crop Behavior</h1>
		<form  method="post" action="/User/avatarUpload" enctype="multipart/form-data" id="uploadForm" >
            <input type="file" name="avatar"><input type="submit" value="保存">
        </form>
		<img id="avatar2" src="demo_files/pool.jpg"/>
		<div style="width:200px;height:200px;overflow:hidden;">
            <img src="demo_files/pool.jpg" id="preview" alt="Preview" class="jcrop-preview" />
        </div>
		<!-- This is the form that our event handler fills -->
		<form action="crop.php" method="post" onsubmit="return checkCoords();">
			<input type="hidden" id="x" name="x" />
			<input type="hidden" id="y" name="y" />
			<input type="hidden" id="w" name="w" />
			<input type="hidden" id="h" name="h" />
			<input type="submit" value="Crop Image" />
		</form>

		<p>
			<b>An example server-side crop script.</b> Hidden form values
			are set when a selection is made. If you press the <i>Crop Image</i>
			button, the form will be submitted and a 150x150 thumbnail will be
			dumped to the browser. Try it!
		</p>

	</div>
	</div>
	</div>
	</body>

</html>