<!DOCTYPE">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>apk2crx</title>
<link href="/static/css1.css" rel="stylesheet" type="text/css" />
<link href="/static/zhuce.css" rel="stylesheet" type="text/css" />
<script src="/static/jquery.js" type="text/javascript"></script>
<script src="/static/spark-md5.js" type="text/javascript"></script>

<style type="text/css">
.file-box{
 width:700px;
 margin:100px auto;
}
.file-box b{
	padding-right: 10px;
}
input{

}
</style>
</head>
<body>	
<include file="Public:headnav" />
<div class="file-box" style="background:#ddd;padding:50px;">
<a href="/Crx"><h4 style="color:blue">{$Think.lang.returnToMainPage}</h4></a>
<br />
<h4 style="margin-bottom:20px">apk2crx : {$Think.lang.app-create-name}</h4>
<form action="/Crx/uploadAPK" method="post" enctype="multipart/form-data">
<input type="radio" checked="checked" name="type" value="phone">  
Phone：  
<input type="radio" name="type" value="pad">
Pad：  
<br /><br />
<input type="hidden" name="key" value="0" id="key"/>
<input type="file" name="file" id="file" accept=".apk" />
<input type="hidden" id="hash">
 <script type="text/javascript">
        
            document.getElementById("file").addEventListener("change", function() {

                var fileReader = new FileReader(), box = document.getElementById('box');
                blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice, file = document.getElementById("file").files[0], chunkSize = 2097152,
                // read in chunks of 2MB
                chunks = Math.ceil(file.size / chunkSize), currentChunk = 0, spark = new SparkMD5();

                fileReader.onload = function(e) {
                    console.log("read chunk nr", currentChunk + 1, "of", chunks);
                    spark.appendBinary(e.target.result);
                    // append binary string
                    currentChunk++;

                    if (currentChunk < chunks) {
                        loadNext();
                    } else {
                        console.log("finished loading");
                        var hash = spark.end();
                        $("#hash").val(hash);
                        $("#upload_button").fadeIn();
                    }
                };

                function loadNext() {
                    var start = currentChunk * chunkSize, end = start + chunkSize >= file.size ? file.size : start + chunkSize;

                    fileReader.readAsBinaryString(blobSlice.call(file, start, end));
                }

                loadNext();
            });
</script>
<script type="text/javascript">
	function getIdByHash(hash){
		$.post("/Crx/getIdByHash", {hash:hash},
		function (data, textStatus){
			myid = data.info.id;
			console.log(myid);
			if(myid==0){
				$("form").submit();
			}
			else{
				$.post("/Crx/uploadHash",{type:$('input[name=type]:checked', 'form').val(),key:$("#key").val(),id:myid},
					function (data,textStatus){
						
						console.log(data.info.id);
						window.location.href = "/Crx/info?id="+data.info.id;
					},"json");
			}
		}, "json");

	}
	function needUpload(){
		var hash=$("#hash").val();
		$("#upload_button").text("{$Think.lang.working}");
		getIdByHash(hash);
		return true;
	}
	
</script>

<!--
<input type="radio" checked="checked" name="key" value="0">
兼容(无key)
<input type="radio" name="key" value="1">
key1
<input type="radio" name="key" value="2">
key2
<input type="radio" name="key" value="3">
key3
<input type="radio" name="key" value="4">
key4
<br /><br />
-->

</form>
<button id="upload_button" onclick="needUpload();" style="display:none;cursor:pointer;border:0px; background:#444; padding:5px 20px;margin:1em 0;font-size:12px; color:#FFF;">{$Think.lang.upload}</button>
<br />

<!--a href="/Crx" target="_blank" style="padding:50px;color:blue">Google Chrome Extensions(已转化完成的)</a-->
</div>




<div class="file-box" style="background:#ddd;padding:50px;">
	Chinese Only: 
	<li style="color:red" title="马化腾，你有种来咬我！">QQ</li>
	<a href="/static/QQ/com.tencent.mqq.android.crx">com.tencent.mqq.android.crx</a><br />
	<a href="/static/QQ/com.tencent.mqq.android(去升级).crx">com.tencent.mqq.android(去升级).crx</a>
</div>
 </body>
</html>